var test = require('tap').test;
var spawn = require('child_process').spawn;
var path = require('path');
var vm = require('vm');

test('node modules symlinks', function (t) {
    t.plan(5);

    var cwd = process.cwd();
    process.chdir(__dirname + '/node_modules_symlinks');

    var ps = spawn(__dirname + '/../bin/cmd.js', [
        'index.js',
        '-t',
        'local-xform'
    ]);
    var src = '';
    var err = '';
    ps.stdout.on('data', function (buf) { src += buf });
    ps.stderr.on('data', function (buf) { err += buf });

    ps.on('exit', function (code) {
        t.equal(code, 0);
        t.equal(err, '');
        console.log(err, src);
        vm.runInNewContext(src, { t: t });
        process.chdir(cwd);
    });
});
